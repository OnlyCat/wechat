
$(window).ready(function(){
     var url = window.location.origin;
     var param = window.location.search;
     var homePage =  $(".content").html();
    function getUrlParam(name) {
        try {
            var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)"); //构造一个含有目标参数的正则表达式对象
            var r = window.location.search.substr(1).match(reg); //匹配目标参数
            if (r != null) return unescape(r[2]);
            return null; //返回参数值
        } catch (e){
            return null;
        }
    }
    function getCurrentData() {
        //获取当日账单数据
        var url = window.location.origin;
        var param = window.location.search;
        $(".s-m-c-content ul").html("");
        uri = "/spend/daySpend"
        daySpendUrl = url + uri + param;
        $.get(daySpendUrl, function (result) {
            result = JSON.parse(result);
            var money = 0;
            for (item in result) {
                money += parseFloat(result[item]['money']);
                node = "<li><div id=" + result[item]['id'] + " class=\"s-c-title\" attr-info = "+ result[item]['classify'] + '·' + result[item]['childr'] +" style=\"background:#" + (result[item]['classify'].charCodeAt(1) * 100 + result[item]['childr'].charCodeAt(1)).toString(16) + "\"  >"+ result[item]['childr'].slice(0,1) +"</div>";
                if(result[item]['isconfirm'] == 1){
                    node += "<div class=\"s-c-explain\">" ;
                } else {
                    node += "<div class=\"s-c-explain btn-confirm\">";
                }
                node = node +"<div class=\"s-c-e-class\">" + result[item]['descripe']
                    + "</div><div class=\"s-c-e-time\">" +
                    result[item]['spendtime'].substr(11)
                    + "</div></div><div class=\"s-c-money\">"
                    + parseFloat(result[item]['money']).toFixed(2)
                    + "</div></li>";
                $(".s-m-c-content ul").append(node);
            }
            $(".m-c-t-content").html(parseFloat(money).toFixed(2));
        });
    }
    $(document).on("click", ".btn-jump", function () {
          switch($(this)[0].classList[1]) {
              case 'home':
                  $(".content").html(homePage)
                  return;
              case 'spend':
                  uri = "/spend/index";
                  break;
              case 'questions':
                  uri = "/question/index";
                  break;
          }
          url = url + uri + param;
          $.get(url, function(result){
              $(".content").html(result)
          })
      });
    var module = getUrlParam("module");
    if(module) {
        switch(module){
            case 'spend':
                uri = "/spend/index";
                break;
            case 'questions':
                uri = "/question/index";
                break;
            default:
                $(".content").html(homePage)
                return;
        }
        url = url + uri + param;
        $.get(url, function(result){
            $(".content").html(result)
        });
    }
    var getRandomColor = function(){
        return  '#' +
            (function(color){
                return (color +=  '0123456789abcdef'[Math.floor(Math.random()*16)])
                && (color.length == 6) ?  color : arguments.callee(color);
            })('');
    }
    var classList = [];
    $(document).on("click", ".btn-confirm", function () {
        var classify = $(this).find(".s-c-e-class");
        var module = $(this).prev(".s-c-title").attr("attr-info").split("·");
        $.get("/spend/getClassList", function (classify) {
            classify = JSON.parse(classify);
            $(".m-e-classify ul").html("");
            $(".m-e-childer ul").html("");
            for(item in classify){
                if(module !== undefined ){
                    $(".s-m-ensure:contains('" + module[0] + "')" ).addClass("active");
                }
                if(module[0] == item) {
                    $(".m-e-classify ul").append(`<li class="active">${item}</li>`);
                } else {
                    $(".m-e-classify ul").append(`<li>${item}</li>`);
                }
                classList[item] =[];
                for(node in classify[item]){
                    if(module[1] == classify[item][node]) {
                        //  var html = `<li><span class="corner"></span>${classify[item][node]}</li>`;
                        var html = `<li class="active">${classify[item][node]}</li>`;
                    } else {
                        var html = `<li>${classify[item][node]}</li>`;
                    }
                    classList[item].push(html);
                }
            }
            $(".m-e-childer ul").html(classList[$(".m-e-classify ul .active").html()]);
        })
        $('input[name="spendid"]').val($(this).prev(".s-c-title").attr("id"));
        $('input[name="division"]').val( $(this).prev(".s-c-title").attr("attr-info"));
        $('input[name="remark"]').val($(this).find('.s-c-e-class').html());
        $('input[name="calendar"]').val( $(this).find(".s-c-e-time").html());

        $('input[name="money"]').val($(this).parent().find(".s-c-money").html());

        $(".bg-shade").css("display","block");
        $(".s-m-ensure").css("display","block");
    })
    $(document).on("click", ".m-e-classify ul li", function () {
        $(".m-e-classify ul li").removeClass("active");
        $(this).addClass("active");
        $(".m-e-childer ul").html(classList[$(".m-e-classify ul .active").html()]);
    });

    $(document).on("click", ".m-e-childer ul li", function (){
        $(".m-e-childer ul li").removeClass("active");
        $(this).addClass("active");
        $("input[name='division']").val($(".m-e-classify ul .active").html() + "·" + $(this).html())
    })
    $(document).on("click", ".m-money-area button", function (){
        $(".s-m-ensure").hide();
        $(".bg-shade").hide();
         $.post("/spend/updateSpend",
             {
              'id' : $("input[name='spendid']").val(),
               "uid" :   getUrlParam("auth"),
              'classify': $(".m-e-classify  ul .active").html(),
              'childer' : $(".m-e-childer ul .active").html(),
              'spendtime': $("input[name='calendar']").val(),
              'money' : $("input[name='money']").val(),
              'remark' : $("input[name='remark']").val()
             },
             function (data) {
                data = JSON.parse(data);
                 getCurrentData();
                if(data['success']){
                    swal("成功！", "记录已修改", "success");
                } else {
                    sweetAlert("失败！", "记录修改失败", "error");
                }
             });
    });
    $(document).on("click", ".m-title ul li", function (){
       var route = $(this).attr('id')
       switch (route){
           case 'a-s-c':
               $(".block-0").animate({left:'0',opacity:1})
               $(".block-1").animate({left:'100%',opacity:1})
               $(".block-2").animate({left:'200%',opacity:1})
               $(this).siblings().removeClass("active")
               $(this).addClass('active')
               break;
           case 'c-s-d':
               $(".block-1").animate({left:'0',opacity:1})
               $(".block-0").animate({left:'100%',opacity:1})
               $(".block-2").animate({left:'200%',opacity:1})
               $(this).siblings().removeClass("active")
               $(this).addClass('active')
               break;
           case 'h-s-p':
               var date = new Date();
               var dateString = date.getFullYear()+"-"+(date.getMonth()+1)+"-"+date.getDate();
               if(!$("input[name='start_date']").val() || !$("input[name='stop_data']").val()){
                   $("input[name='start_date']").val(date.getFullYear() + "-01-01")
                   $("input[name='stop_data']").val(dateString)
               }
               $(".block-2").animate({left:'0',opacity:1})
               $(".block-0").animate({left:'100%',opacity:1})
               $(".block-1").animate({left:'200%',opacity:1})
               $(this).siblings().removeClass("active")
               $(this).addClass('active')
               break;
       }
    })
    $(document).on("click", ".s-m-title-spend .btn-condition .cond-title", function (){
            $(this).parent().parent().animate({height:'8rem', opacity:1})
            $(this).parent().find('.fa').removeClass('fa-chevron-down')
            $(this).parent().find('.fa').addClass('fa-chevron-up')
            $(this).parent().find(".cond-title").hide();
            $(this).parent().find('.select-area').show();
    })

    $(document).on("click", ".s-m-title-spend .btn-condition .select-area .s-a-input .btn-input .btn-module", function () {
        $(this).parent().parent().parent().parent().parent().parent().parent().animate({height: '3.5rem', opacity: 1})
        $(this).parent().parent().parent().parent().parent().parent().find('.fa').removeClass('fa-chevron-up')
        $(this).parent().parent().parent().parent().parent().parent().find('.fa').addClass('fa-chevron-down')
        $(this).parent().parent().parent().parent().parent().parent().find(".cond-title").show();
        $(this).parent().parent().parent().parent().parent().parent().find('.select-area').hide();
        $(".btn-input .btn-module").removeClass("active");

        var start_data = $("input[name='start_date']").val().split("-");
        var stop_data = $("input[name='stop_data']").val().split("-");
        var type = $(this).html()

        var $_titile =  $('.cond-title').html();
        switch(type){
            case '年':
                type = 'year';
                $_titile = start_data[0] + "年-" + stop_data[0] + "年账单";
                break;
            case '月':
                type = 'month';
                $_titile = start_data[0] + "年" + start_data[1] +"月-"+ stop_data[0] + "年" + stop_data[1] +"月账单";
                break;
            case '日':
                type = 'day';
                $_titile = start_data[0] + "/" + start_data[1] +"/"+  start_data[2] + " - " +  stop_data[0] + "/" + stop_data[1] +"/" + stop_data[2] +"账单";
                break;
        }
        $('.cond-title').html($_titile);
        $(this).addClass("active");
    })
});